<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Mapping One Pixel at a Time &#8211; Mapping Vermont</title>
<meta name="description" content="Rendering tiles dynamically using HTML5 canvas">
<meta name="keywords" content="leaflet, javascript, canvas">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Mapping One Pixel at a Time">
<meta property="og:description" content="Rendering tiles dynamically using HTML5 canvas">
<meta property="og:url" content="http://localhost:4000/web/2016/07/02/leaflet-tiles-in-the-browser/">
<meta property="og:site_name" content="Mapping Vermont">





<link rel="canonical" href="http://localhost:4000/web/2016/07/02/leaflet-tiles-in-the-browser/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Mapping Vermont Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.min.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://localhost:4000">Mapping Vermont</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				<li><a href="http://localhost:4000/about/" >About</a></li>
		        
				<li><a href="http://localhost:4000/posts/" >Posts</a></li>
		        
				<li><a href="http://localhost:4000/projects/" >Projects</a></li>
		        
				<li><a href="http://localhost:4000/data/" >Data</a></li>
		        
				<li><a href="http://localhost:4000/resources/" >Resources</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <img src="http://localhost:4000/images/bio-photo.jpg" class="bio-photo" alt="MappingVermont bio photo"></a>
<h3>MappingVermont</h3>
<p></p>





<a href="http://github.com/mappingvermont" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>



  </div>
  <article>
    <div class="headline-wrap">
      <h1>Mapping One Pixel at a Time</h1>
      <h2></h2>
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Big news! I just started a new job working for <a href="http://globalforestwatch.org/map">Global Forest Watch</a>. I’m thrilled to join the team here in DC, and excited to be part of their everything-but-the-kitchen-sink approach to mapping– arcpy and GDAL for local data processing,  ArcGIS Server, TileMill and CartoDB for map services, and Leaflet and the ArcGIS JS API for web mapping.</p>

<p><br />
One of the things that got me interested in their work was how fast their raster data could be visualized and filtered by date. Here’s <a href="http://www.globalforestwatch.org/map/9/-2.80/113.88/ALL/grayscale/umd_as_it_happens?tab=analysis-tab&amp;begin=2015-01-01&amp;end=2016-06-09">an example</a> of GLAD alert data (30 x 30m pixels showing areas of likely deforestation). If I were building this site, I would use an esri image service to display this data. When a user hit the play button, the site would make an export map request to the service with start/end date parameters for the map of deforestation. This request would succeed, but it wouldn’t be fast enough to keep up with the time slider presented in the website, which would need to make a new request multiple times per second.</p>

<p><br />
How does it work, then? Instead of making multiple calls to a service, the site loads map tiles for each area once. These tiles use specific RGB values as a way to encode date information. Each color is represented in RGB color space, with values of 1 - 255 for Red, Green, and Blue. The website reads these colors, then applies a function to translate the color to a date value they represent.</p>

<p><br />
For this deforestation service, the date can be decoded by multiplying the the red band value by 255, then adding the green band value to it. This gives the total number of days after January 1, 2015. Deforestation that occurred on 1/10/2015, for example, would be Red: 0, Blue: 10, or (255 * 0) + (10). This date information is decoded client side, and the browser turns all the pixels that are within the date range selected pink. If a pixel doesn’t match the date range shown, the browser will turn the pixel transparent.</p>

<p><br />
I think what I like most about this approach is how it comes down to basic computer science. All we’re really doing here is manipulating an image. We don’t need a fancy server to turn on/off different colors, we just need to read all the pixels of an image, apply a function to the values, then change their colors. Computers are really good at this, and web browsers in particular. All the work is pushed to the client side, the server just has to provide a static map tile.</p>

<p><br />
To better understand how to access the pixel values of map tiles in the browser, I found a <a href="https://johngravois.com/lerc-leaflet">great example</a> from John Gravois. I repurposed it to read imagery tiles from an ArcGIS Image Server <a href="http://rawgit.com/mappingvermont/32e9b947fc7bf60c91cecd460fc7b0bf/raw/0519e45e4783c1c50735452886013cb2ba695c77/leaflet_canvas.html">here</a>. Now that we have a handle on each pixel being read to the map, we can alter the image data. Based on this <a href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas">Mozilla image tutorial</a>, we can modify the RGB value displayed using the following code:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="kd">var</span> <span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>     <span class="c1">// red
</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// green
</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span> <span class="c1">// blue
</span>
    <span class="p">}</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">putImageData</span><span class="p">(</span><span class="nx">imageData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span></code></pre></figure>

<p>I’ve used this function to <a href="http://rawgit.com/mappingvermont/c7056e7cd0f68af6f75c98d493ead337/raw/440f4d430fb0e5898f86736b2ad8d99ac8b2fcff/leaflet_canvas_invert.html">invert every pixel in that same ArcGIS Image Service and display it</a>. Pretty cool, huh? I like how surreal it looks– the street trees of Toronto all turned white. It’s amazing how fast it draws too. We’re literally changing every pixel of a satellite image in the browser, and it performs just like a normal image service. More next time on using this approach to solve an actual mapping problem!</p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          <img src="http://localhost:4000/images/bio-photo.jpg" class="bio-photo" alt="MappingVermont bio photo"></a>
<h3>MappingVermont</h3>
<p></p>





<a href="http://github.com/mappingvermont" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>



        </div>
        </footer>
    </div><!-- /.article-wrap -->
  </article>

</div><!-- /#main -->

<div class="footer-wrap">

  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://localhost:4000/posts/">View all posts</a>)</small></h4>
    <ul>
    
      
      
      
      <li><a href="http://localhost:4000/web/2021/11/27/famous-vermonters/" title="Famous Vermonters">Famous Vermonters</a></li>
      
    
      
      
      
      <li><a href="http://localhost:4000/web/2017/10/09/vermont-town-tracker/" title="Vermont Town Tracker">Vermont Town Tracker</a></li>
      
    
      
      
      
      <li><a href="http://localhost:4000/web/2017/08/13/sanborn-chrome-extension/" title="A Sanborn Map For Every New Tab">A Sanborn Map For Every New Tab</a></li>
      
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  <footer>
    <span>&copy; 2023 MappingVermont. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>
	        

</body>
</html>
